import { createSignal, createMemo, For, Show } from "solid-js";
import Heading from "~/components/Headings";
import Tables from "~/components/Tables";
import Pagination from "~/components/Pagination";
import Combobox from "~/components/Combobox";
import Modal from "~/components/Modal";

interface User {
name: string;
username: string;
email: string;
picture: string;
active: boolean;
}

export default function UserManagement() {
const [users, setUsers] = createSignal<User[]>([
{
name: "Ayşe Çakıl",
username: "aysecakil",
email: "ayse@example.com",
picture: "https://randomuser.me/api/portraits/women/1.jpg",
active: true,
},
{
name: "Mehmet Yılmaz",
username: "mehmety",
email: "mehmet@example.com",
picture: "https://randomuser.me/api/portraits/men/2.jpg",
active: false,
},
]);

const [selectedUsername, setSelectedUsername] = createSignal("");
const [isModalOpen, setModalOpen] = createSignal(false);
const [modalMode, setModalMode] = createSignal<"create" | "update">("create");
const [editingUser, setEditingUser] = createSignal<User | null>(null);
    const [currentPage, setCurrentPage] = createSignal(1);
    const resultsPerPage = 2;

    const filteredUsers = createMemo(() => {
    const all = users();
    if (!selectedUsername()) return all;
    return all.filter((u) => u.username === selectedUsername());
    });

    const paginatedUsers = createMemo(() => {
    const start = (currentPage() - 1) * resultsPerPage;
    return filteredUsers().slice(start, start + resultsPerPage);
    });

    const totalPages = createMemo(() =>
    Math.ceil(filteredUsers().length / resultsPerPage)
    );

    const handleEdit = (user: User) => {
    setEditingUser(user);
    setModalMode("update");
    setModalOpen(true);
    };

    const handleCreate = () => {
    setEditingUser(null);
    setModalMode("create");
    setModalOpen(true);
    };

    const handleSave = (e: Event) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const newUser: User = {
    name: formData.get("name") as string,
    username: formData.get("username") as string,
    email: formData.get("email") as string,
    picture:
    editingUser()?.picture ||
    "https://randomuser.me/api/portraits/lego/1.jpg",
    active: formData.get("active") === "on",
    };

    if (modalMode() === "create") {
    setUsers([...users(), newUser]);
    } else {
    setUsers(
    users().map((u) =>
    u.username === editingUser()?.username ? newUser : u
    )
    );
    }

    setModalOpen(false);
    };

    return (
    <main class="p-6">
        <Heading
                title="Kullanıcı Yönetimi"
                description="Kullanıcı adına göre filtreleyin, yeni kullanıcı ekleyin ya da güncelleyin."
        >
            <Combobox
                    name="user-filter"
                    placeholder="Kullanıcı seçin"
                    options={[{ value: "", label: "Tümü" }, ...users().map((u) => ({
            value: u.username,
            label: u.username,
            }))]}
            value={selectedUsername()}
            onChange={(val) => setSelectedUsername(val)}
            />

            <button
                    class="bg-sky-600 text-white px-3 py-1 rounded hover:bg-sky-700"
                    onClick={handleCreate}
            >
                Yeni Kullanıcı
            </button>
        </Heading>

        <Tables users={paginatedUsers()} onEdit={(user) => handleEdit(user)} />

        <Pagination
                currentPage={currentPage()}
                totalPages={totalPages()}
                totalResults={filteredUsers().length}
                onPageChange={setCurrentPage}
                resultsPerPage={resultsPerPage}
        />

        <Modal
                open={isModalOpen()}
                onClose={() => setModalOpen(false)}
        title={modalMode() === "create" ? "Yeni Kullanıcı" : "Kullanıcıyı Güncelle"}
        >
        <form onSubmit={handleSave} class="flex flex-col gap-3">
            <input
                    type="text"
                    name="name"
                    placeholder="Ad Soyad"
                    class="border px-3 py-2 rounded"
                    required
                    value={editingUser()?.name || ""}
            />
            <input
                    type="text"
                    name="username"
                    placeholder="Kullanıcı Adı"
                    class="border px-3 py-2 rounded"
                    required
                    value={editingUser()?.username || ""}
            />
            <input
                    type="email"
                    name="email"
                    placeholder="Email"
                    class="border px-3 py-2 rounded"
                    required
                    value={editingUser()?.email || ""}
            />
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" name="active" checked={editingUser()?.active} /> Aktif mi?
            </label>
            <button
                    type="submit"
                    class="bg-sky-600 text-white px-4 py-2 rounded hover:bg-sky-700"
            >
                Kaydet
            </button>
        </form>
        </Modal>
    </main>
    );
    }
